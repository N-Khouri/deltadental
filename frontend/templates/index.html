<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Data Quality Dashboard â€“ Upload</title>
    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            margin: 2rem;
        }

        nav {
            margin-bottom: 1rem;
        }

        nav a {
            margin-right: 1rem;
        }

        .card {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 980px;
        }

        .row {
            display: flex;
            gap: .75rem;
            align-items: center;
        }

        button {
            padding: .6rem 1rem;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            cursor: pointer;
        }

        .ok {
            color: #065f46;
        }

        .err {
            color: #7f1d1d;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        th, td {
            border: 1px solid #e5e7eb;
            padding: .5rem;
            text-align: left;
        }

        th {
            background: #f9fafb;
        }

        pre {
            background: #0b1020;
            color: #e5e7eb;
            padding: 1rem;
            border-radius: 10px;
            overflow-x: auto;
        }

        small {
            color: #6b7280;
        }
    </style>
</head>
<body>
<nav>
    <a href="/">Upload</a>
    <a href="/history">History</a>
</nav>

<h1>Data Quality Dashboard</h1>

<div class="card">
    <form id="upload-form">
        <div class="row">
            <input type="file" name="file" id="file" accept=".csv" required/>
            <button type="submit">Upload CSV</button>
        </div>
        <p><small>Max size: 10 MB. Only .csv files are accepted.</small></p>
    </form>

    <div id="success" class="ok" style="display:none"></div>
    <div id="error" class="err" style="display:none"></div>

    <div id="meta" style="display:none">
        <h3>File Summary</h3>
        <table>
            <tbody>
            <tr>
                <th>Filename</th>
                <td id="m-filename"></td>
            </tr>
            <tr>
                <th>Saved To</th>
                <td id="m-saved"></td>
            </tr>
            <tr>
                <th>Rows</th>
                <td id="m-rows"></td>
            </tr>
            <tr>
                <th>Columns</th>
                <td id="m-cols"></td>
            </tr>
            </tbody>
        </table>
        <div id="cols" style="display:none">
            <h4>All Headers</h4>
            <table id="cols-table">
                <thead>
                <tr>
                    <th>#</th>
                    <th>Column</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="dq" style="display:none">
        <h3>Missing Values by Column</h3>
        <table id="dq-null-table">
            <thead>
            <tr>
                <th>#</th>
                <th>Column</th>
                <th>Missing</th>
                <th>Missing %</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="formats" style="display:none">
        <h3>Formats</h3>
        <table id="formats-table">
            <thead>
            <tr>
                <th>#</th>
                <th>Metric</th>
                <th>Count</th>
                <th>Error % (rounded to the nearest thousandth)</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="logics" style="display:none">
        <h3>Logical Inconsistencies</h3>
        <table id="logics-table">
            <thead>
            <tr>
                <th>#</th>
                <th>Metric</th>
                <th>Count</th>
                <th>Error % (rounded to the nearest thousandth)</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="dups" style="display:none">
        <h3>Total Duplicate Records</h3>
        <table id="dups-table">
            <thead>
            <tr>
                <th>#</th>
                <th>Metric</th>
                <th>Count</th>
                <th>Error % (rounded to the nearest thousandth)</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="outliers" style="display:none">
        <h3>Outliers</h3>
        <table id="outliers-table">
            <thead>
            <tr>
                <th>#</th>
                <th>Metric</th>
                <th>Count</th>
                <th>Error % (rounded to the nearest thousandth)</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <h3>Raw Response</h3>
    <pre id="result">(no upload yet)</pre>
</div>

<script>
    const form = document.getElementById("upload-form");
    const result = document.getElementById("result");
    const ok = document.getElementById("success");
    const err = document.getElementById("error");
    const meta = document.getElementById("meta");

    const cols = document.getElementById("cols");
    const colsBody = document.querySelector("#cols-table tbody");

    const dq = document.getElementById("dq");
    const dqBody = document.querySelector('#dq-null-table tbody');

    const formatsSection = document.getElementById('formats');
    const formatsBody = document.querySelector('#formats-table tbody');

    const logicsSection = document.getElementById('logics');
    const logicsBody = document.querySelector('#logics-table tbody');

    const dupsSection = document.getElementById('dups');
    const dupsBody = document.querySelector('#dups-table tbody');

    const outlierSection = document.getElementById('outliers');
    const outlierBody = document.querySelector('#outliers-table tbody');

    const mFile = document.getElementById("m-filename");
    const mPath = document.getElementById("m-saved");
    const mRows = document.getElementById("m-rows");
    const mCols = document.getElementById("m-cols");
    const mColsList = document.getElementById("m-columns");

    function numberFmt(x) {
        if (typeof x === 'number') return x.toLocaleString();
        return x;
    }

    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const data = new FormData(form);

        ok.style.display = "none";
        err.style.display = "none";
        meta.style.display = "none";

        cols.style.display = "none";
        colsBody.innerHTML = '';
        dq.style.display = "none";
        dqBody.innerHTML = '';
        formatsSection.style.display = "none";
        formatsBody.innerHTML = '';
        logicsSection.style.display = "none";
        logicsBody.innerHTML = '';
        dupsSection.style.display = "none";
        dupsBody.textContent = '';
        outlierSection.style.display = "none";
        outlierBody.textContent = '';

        result.textContent = "Uploading...";

        try {
            const res = await fetch("/upload", {method: "POST", body: data});
            const text = await res.text();
            result.textContent = text;

            let json;
            try {
                json = JSON.parse(text);
            } catch (_) {
            }

            if (res.ok && json) {
                ok.textContent = json.message || "Upload ok";
                ok.style.display = "block";

                if (json.filename) mFile.textContent = json.filename;
                if (json.saved_to) mPath.textContent = json.saved_to;
                if (typeof json.row_count === 'number') mRows.textContent = numberFmt(json.row_count);
                if (typeof json.column_count === 'number') mCols.textContent = numberFmt(json.column_count);
                if (json.columns && Array.isArray(json.columns)) {
                    json.columns.forEach((col, i) => {
                        const tr = document.createElement("tr");
                        tr.innerHTML = `
                        <td>${++i}</td>
                        <td>${col}</td>`
                        colsBody.appendChild(tr);
                    })
                    cols.style.display = "block";
                }
                meta.style.display = "block";

                if (Array.isArray(json.nulls)) {
                    json.nulls.forEach((r, i) => {
                        if (r.missing > 0) {
                            const tr = document.createElement('tr');
                            const pct = (typeof r.missing_pct === 'number') ? r.missing_pct.toFixed(2) + '%' : r.missing_pct;
                            tr.innerHTML = `
                                  <td>${i + 1}</td>
                                  <td>${r.column ?? ''}</td>
                                  <td>${numberFmt(r.missing)}</td>
                                  <td>${pct}</td>`;
                            dqBody.appendChild(tr);
                        }
                    });
                    dq.style.display = 'block';
                }

                if (json.formats && typeof json.formats === 'object') {
                    const rows = [
                        ["email_invalid", "email_invalid_pct", "Invalid Emails"],
                        ["future_dates", "future_dates_pct", "Future Dates"],
                        ["unrealistic_ages", "total_unrealistic_pct", "Unrealistic Ages"],
                        ["invalid_statuses", "invalid_statuses_pct", "Invalid Statuses"],
                    ];
                    let idx = 1, any = false;
                    rows.forEach(([key, pct, label]) => {
                        const val = json.formats[key];
                        const pct_val = json.formats[pct].toFixed(2) >= 0.01 ? json.formats[pct].toFixed(2) + "%" : "Too small of a margin";

                        if (typeof val === 'number' && val > 0) {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${idx++}</td>
                                <td>${label}</td>
                                <td>${numberFmt(val)}</td>
                                <td>${pct_val}</td>
                            `;
                            formatsBody.appendChild(tr);
                            any = true;
                        }
                    });
                    if (any) formatsSection.style.display = 'block';
                }

                if (json.logical_inconsistencies && typeof json.logical_inconsistencies === 'object') {
                    const rows = [
                        ["sell_less_cost", "sell_less_cost_pct", "Current Stock Selling Less than Cost"],
                        ["stock_less_reorder", "stock_less_reorder_pct", "Current Stock Levels Less Than Reorder Levels"],
                    ];
                    let idx = 1, any = false;
                    rows.forEach(([key, pct, label]) => {
                        const val = json.logical_inconsistencies[key];
                        const pct_val = json.logical_inconsistencies[pct].toFixed(2) >= 0.01 ? json.logical_inconsistencies[pct].toFixed(2) + "%" : "Too small of a margin";
                        if (typeof val === 'number' && val > 0) {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${idx++}</td>
                                <td>${label}</td>
                                <td>${numberFmt(val)}</td>
                                <td>${pct_val}</td>
                            `;
                            logicsBody.appendChild(tr);
                            any = true;
                        }
                    });
                    if (any) logicsSection.style.display = 'block';
                }
                if (json.duplicates) {
                    rows = [
                        ["total_duplicates_records", "total_duplicates_records_pct", "Duplicate Records Found"],
                    ]
                    let any = false;
                    rows.forEach(([key, pct, label], i) => {
                        const val = json.duplicates[key];
                        const pct_val = json.duplicates[pct].toFixed(2) > 0.01 ? json.duplicates[pct].toFixed(2) + "%" : "Too small of a margin";
                        if (typeof val === 'number' && val > 0) {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${++i}</td>
                                <td>${label}</td>
                                <td>${numberFmt(val)}</td>
                                <td>${pct_val}</td>
                            `;
                            dupsBody.appendChild(tr);
                            any = true;
                        }
                    })
                    if (any) dupsSection.style.display = 'block';
                }

                if (json.outliers) {
                    const rows = [
                        ["total_invalid_methods", "total_invalid_methods_pct", "Total Invalid Payment Methods"],
                        ["negative_total_amount", "negative_total_amount_pct", "Negative Total Amount"],
                        ["error_total_amount", "error_total_amount_pct", "Total Unknown Total Amount"]
                    ]
                    let idx = 1, any = false;
                    rows.forEach(([key, pct, label]) => {
                        const val = json.outliers[key];
                        const pct_val = json.outliers[pct].toFixed(2) >= 0.01 ? json.outliers[pct].toFixed(2) + "%" : "Too small of a margin";
                        if (typeof val === 'number' && val > 0) {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                            <td>${idx++}</td>
                            <td>${label}</td>
                            <td>${numberFmt(val)}</td>
                            <td>${pct_val}</td>
                            `
                            outlierBody.appendChild(tr);
                            any = true;
                        }
                    })
                    if (any) outlierSection.style.display = 'block';
                }
            } else {
                err.textContent = (json && (json.error || json.message)) || `HTTP ${res.status}`;
                err.style.display = "block";
            }
        } catch (e) {
            result.textContent = `Error: ${e}`;
            err.textContent = String(e);
            err.style.display = "block";
        }
    });
</script>
</body>
</html>