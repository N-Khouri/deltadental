<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Data Quality Dashboard â€“ Upload</title>
    <style>
        :root {
            --bg: #0b0f14;
            --card: #10161d;
            --muted: #8b98a5;
            --border: #1f2a35;
            --text: #e5eef7;
            --accent: #4ea1ff;
            --good: #22c55e;
            --bad: #ef4444;
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
        }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            color: var(--text);
            background: linear-gradient(180deg, #0b0f14, #0e141b);
        }

        header {
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: blur(6px);
            background: rgba(11, 15, 20, .7);
            border-bottom: 1px solid var(--border);
        }

        .wrap {
            max-width: 1100px;
            margin: 0 auto;
            padding: 1rem 1.25rem;
        }

        nav {
            display: flex;
            justify-content: center;
        }

        nav a[aria-current="page"] {
            color: var(--text);
        }

        nav a {
            color: var(--muted);
            text-decoration: none;
            font-weight: 600;
            padding: .35rem .6rem;
            border-radius: 8px;
            border: 1px solid transparent;
        }

        nav a:hover,
        nav a:focus-visible {
            color: var(--text);
            border-color: var(--border);
            outline: none;
        }

        h1 {
            max-width: 1100px;
            margin: 1rem auto .75rem;
            font-size: 1.6rem;
        }

        .card {
            max-width: 1100px;
            margin: 1rem auto 2rem;
            padding: 1.25rem;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
        }

        .row {
            display: flex;
            gap: .75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        input[type="file"] {
            display: none;
        }

        small {
            color: var(--muted);
        }

        button, .custom-file-upload {
            font: inherit;
            line-height: 1.2;
        }

        .custom-file-upload {
            display: inline-block;
            max-width: 360px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            vertical-align: middle;
        }

        button, .custom-file-upload {
            padding: .6rem 1rem;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: #0b1117;
            color: var(--text);
            cursor: pointer;
            transition: transform .02s ease, background .15s ease, border-color .15s ease;
        }

        button:hover, .custom-file-upload:hover {
            background: #0d141b;
        }

        button:active, .custom-file-upload:active {
            transform: translateY(1px);
        }

        button:focus-visible, .custom-file-upload:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        .ok {
            color: var(--good);
            margin: .75rem 0;
        }

        .err {
            color: var(--bad);
            margin: .75rem 0;
        }

        table {
            table-layout: fixed;
            width: 100%;
            border-collapse: collapse;
            border-spacing: 0;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            margin: .75rem 0 1.25rem;
        }

        th, td {
            border-bottom: 1px solid var(--border);
            padding: .65rem .8rem;
            text-align: left;
            vertical-align: top;
        }

        thead th:first-child, tbody td:first-child {
            width: 40px;
        }

        thead th:not:first-child, tbody td:first-child {
            width: calc(100% - 40px);
        }

        thead th {
            position: sticky;
            background: #0d141b;
            color: var(--muted);
            font-weight: 600;
            font-size: .85rem;
            text-transform: uppercase;
            letter-spacing: .02em;
            border-bottom: 1px solid var(--border);
        }

        thead th, tbody td {
            overflow: hidden;
            text-overflow: clip;
            white-space: nowrap;
        }


        tbody tr:hover {
            background: rgba(78, 161, 255, .06);
        }

        .card h3, .card h4 {
            margin: 1.25rem 0 .5rem;
            color: var(--text);
        }

        @media (max-width: 900px) {
            h1 {
                padding: 0 1rem;
            }

            .card {
                margin: 1rem 1rem 2rem;
                padding: 1rem;
            }

            td {
                border-bottom: none;
            }

            tbody tr {
                border-bottom: 1px solid var(--border);
                margin-bottom: .5rem;
            }
        }


    </style>
</head>
<body>
<header>
    <div class="wrap">
        <nav>
            <a href="/" aria-current="page">Upload</a>
            <a href="/history">History</a>
        </nav>
        <h1>Data Quality Dashboard</h1>
    </div>
</header>


<div class="card">
    <form id="upload-form">
        <div class="row">
            <span id="file-selected">
                <label for="file" class="custom-file-upload">
                    Choose file
                </label>
                <input type="file" name="file" id="file" accept=".csv" required/>
            </span>
            <button type="submit">Upload CSV</button>
        </div>
        <p><small>Max size: 10 MB. Only .csv files are accepted.</small></p>
    </form>

    <div id="success" class="ok" style="display:none"></div>
    <div id="error" class="err" style="display:none"></div>

    <div id="meta" style="display:none">
        <h3>File Summary</h3>
        <table>
            <tbody>
            <tr>
                <th>Filename</th>
                <td id="m-filename"></td>
            </tr>
            <tr>
                <th>Saved To</th>
                <td id="m-saved"></td>
            </tr>
            <tr>
                <th>Rows</th>
                <td id="m-rows"></td>
            </tr>
            <tr>
                <th>Columns</th>
                <td id="m-cols"></td>
            </tr>
            </tbody>
        </table>
        <div id="cols" style="display:none">
            <h4>All Column Headers</h4>
            <table id="cols-table">
                <thead>
                <tr>
                    <th>#</th>
                    <th>Column</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="dq" style="display:none">
        <h3>Missing Values</h3>
        <table id="dq-null-table">
            <thead>
            <tr>
                <th>#</th>
                <th>Column</th>
                <th>Missing</th>
                <th>Missing %</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="formats" style="display:none">
        <h3>Formats</h3>
        <table id="formats-table">
            <thead>
            <tr>
                <th>#</th>
                <th>Metric</th>
                <th>Count</th>
                <th>Error %</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="logics" style="display:none">
        <h3>Logical Inconsistencies</h3>
        <table id="logics-table">
            <thead>
            <tr>
                <th>#</th>
                <th>Metric</th>
                <th>Count</th>
                <th>Error %</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="dups" style="display:none">
        <h3>Total Duplicate Records</h3>
        <table id="dups-table">
            <thead>
            <tr>
                <th>#</th>
                <th>Metric</th>
                <th>Count</th>
                <th>Error %</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="outliers" style="display:none">
        <h3>Outliers</h3>
        <table id="outliers-table">
            <thead>
            <tr>
                <th>#</th>
                <th>Metric</th>
                <th>Count</th>
                <th>Error % (rounded to the nearest thousandth)</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
    const form = document.getElementById("upload-form");
    const ok = document.getElementById("success");
    const err = document.getElementById("error");
    const meta = document.getElementById("meta");

    const cols = document.getElementById("cols");
    const colsBody = document.querySelector("#cols-table tbody");

    const dq = document.getElementById("dq");
    const dqBody = document.querySelector('#dq-null-table tbody');

    const formatsSection = document.getElementById('formats');
    const formatsBody = document.querySelector('#formats-table tbody');

    const logicsSection = document.getElementById('logics');
    const logicsBody = document.querySelector('#logics-table tbody');

    const dupsSection = document.getElementById('dups');
    const dupsBody = document.querySelector('#dups-table tbody');

    const outlierSection = document.getElementById('outliers');
    const outlierBody = document.querySelector('#outliers-table tbody');

    const mFile = document.getElementById("m-filename");
    const mPath = document.getElementById("m-saved");
    const mRows = document.getElementById("m-rows");
    const mCols = document.getElementById("m-cols");
    const mColsList = document.getElementById("m-columns");

    const fileInput = document.querySelector('input[type="file"][name="file"]');
    const fileLabel = document.querySelector('#file-selected .custom-file-upload');

    function numberFmt(x) {
        if (typeof x === 'number') return x.toLocaleString();
        return x;
    }

    if (fileInput && fileLabel) {
        fileInput.addEventListener('change', () => {
            fileLabel.textContent = fileInput.files[0].name;
            fileLabel.title = fileInput.files[0].name;
        });
    }

    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const data = new FormData(form);

        ok.style.display = "none";
        err.style.display = "none";
        meta.style.display = "none";

        cols.style.display = "none";
        colsBody.innerHTML = '';
        dq.style.display = "none";
        dqBody.innerHTML = '';
        formatsSection.style.display = "none";
        formatsBody.innerHTML = '';
        logicsSection.style.display = "none";
        logicsBody.innerHTML = '';
        dupsSection.style.display = "none";
        dupsBody.textContent = '';
        outlierSection.style.display = "none";
        outlierBody.textContent = '';

        try {
            const res = await fetch("/upload", {method: "POST", body: data});
            const text = await res.text();

            let json;
            try {
                json = JSON.parse(text);
            } catch (_) {
            }

            fileLabel.textContent = "Upload file";
            fileLabel.title = '';

            if (res.ok && json) {
                ok.textContent = json.message || "Upload ok";
                ok.style.display = "block";

                if (json.filename) mFile.textContent = json.filename;
                if (json.saved_to) mPath.textContent = json.saved_to;
                if (typeof json.row_count === 'number') mRows.textContent = numberFmt(json.row_count);
                if (typeof json.column_count === 'number') mCols.textContent = numberFmt(json.column_count);
                if (json.columns && Array.isArray(json.columns)) {
                    json.columns.forEach((col, i) => {
                        const tr = document.createElement("tr");
                        tr.innerHTML = `
                        <td>${++i}</td>
                        <td>${col}</td>`
                        colsBody.appendChild(tr);
                    })
                    cols.style.display = "block";
                }
                meta.style.display = "block";

                if (Array.isArray(json.nulls)) {
                    json.nulls.forEach((r, i) => {
                        if (r.missing > 0) {
                            const tr = document.createElement('tr');
                            const pct = (typeof r.missing_pct === 'number') ? r.missing_pct.toFixed(2) + '%' : r.missing_pct;
                            tr.innerHTML = `
                                  <td>${i + 1}</td>
                                  <td>${r.column ?? ''}</td>
                                  <td>${numberFmt(r.missing)}</td>
                                  <td>${pct}</td>`;
                            dqBody.appendChild(tr);
                        }
                    });
                    dq.style.display = 'block';
                }

                if (json.formats && typeof json.formats === 'object') {
                    const rows = [
                        ["email_invalid", "email_invalid_pct", "Invalid Emails"],
                        ["future_dates", "future_dates_pct", "Future Dates"],
                        ["unrealistic_ages", "total_unrealistic_pct", "Unrealistic Ages"],
                        ["invalid_statuses", "invalid_statuses_pct", "Invalid Statuses"],
                    ];
                    let idx = 1, any = false;
                    rows.forEach(([key, pct, label]) => {
                        const val = json.formats[key];
                        const pct_val = json.formats[pct].toFixed(2) >= 0.01 ? json.formats[pct].toFixed(2) + "%" : "Too small of a margin";

                        if (typeof val === 'number' && val > 0) {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${idx++}</td>
                                <td>${label}</td>
                                <td>${numberFmt(val)}</td>
                                <td>${pct_val}</td>
                            `;
                            formatsBody.appendChild(tr);
                            any = true;
                        }
                    });
                    if (any) formatsSection.style.display = 'block';
                }

                if (json.logical_inconsistencies && typeof json.logical_inconsistencies === 'object') {
                    const rows = [
                        ["sell_less_cost", "sell_less_cost_pct", "Current Stock Selling Less than Cost"],
                        ["stock_less_reorder", "stock_less_reorder_pct", "Current Stock Levels Less Than Reorder Levels"],
                    ];
                    let idx = 1, any = false;
                    rows.forEach(([key, pct, label]) => {
                        const val = json.logical_inconsistencies[key];
                        const pct_val = json.logical_inconsistencies[pct].toFixed(2) >= 0.01 ? json.logical_inconsistencies[pct].toFixed(2) + "%" : "Too small of a margin";
                        if (typeof val === 'number' && val > 0) {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${idx++}</td>
                                <td>${label}</td>
                                <td>${numberFmt(val)}</td>
                                <td>${pct_val}</td>
                            `;
                            logicsBody.appendChild(tr);
                            any = true;
                        }
                    });
                    if (any) logicsSection.style.display = 'block';
                }
                if (json.duplicates) {
                    const rows = [
                        ["total_duplicates_records", "total_duplicates_records_pct", "Duplicate Records Found"],
                    ]
                    let any = false;
                    rows.forEach(([key, pct, label], i) => {
                        const val = json.duplicates[key];
                        const pct_val = json.duplicates[pct].toFixed(2) > 0.01 ? json.duplicates[pct].toFixed(2) + "%" : "Too small of a margin";
                        if (typeof val === 'number' && val > 0) {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${++i}</td>
                                <td>${label}</td>
                                <td>${numberFmt(val)}</td>
                                <td>${pct_val}</td>
                            `;
                            dupsBody.appendChild(tr);
                            any = true;
                        }
                    })
                    if (any) dupsSection.style.display = 'block';
                }

                if (json.outliers) {
                    const rows = [
                        ["total_invalid_methods", "total_invalid_methods_pct", "Total Invalid Payment Methods"],
                        ["negative_total_amount", "negative_total_amount_pct", "Negative Total Amount"],
                        ["error_total_amount", "error_total_amount_pct", "Total Unknown Total Amount"],
                        ["total_pricing_error", "total_pricing_error_pct", "Total Pricing Error"]
                    ]
                    let idx = 1, any = false;
                    rows.forEach(([key, pct, label]) => {
                        const val = json.outliers[key];
                        const pct_val = json.outliers[pct].toFixed(2) >= 0.01 ? json.outliers[pct].toFixed(2) + "%" : "Too small of a margin";
                        if (typeof val === 'number' && val > 0) {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                            <td>${idx++}</td>
                            <td>${label}</td>
                            <td>${numberFmt(val)}</td>
                            <td>${pct_val}</td>
                            `
                            outlierBody.appendChild(tr);
                            any = true;
                        }
                    })
                    if (any) outlierSection.style.display = 'block';
                }
            } else {
                err.textContent = (json && (json.error || json.message)) || `HTTP ${res.status}`;
                err.style.display = "block";
            }
        } catch (e) {
            result.textContent = `Error: ${e}`;
            err.textContent = String(e);
            err.style.display = "block";
        }
    });
</script>
</body>
</html>